import streamlit as st
import pandas as pd
import plotly.graph_objects as go

# --- ãƒšãƒ¼ã‚¸è¨­å®š ---
st.set_page_config(page_title="My Perfect Tax Manager", layout="wide")
st.title("ğŸ›¡ï¸ My Perfect Tax Manager")

# ==========================================
# ã‚¿ãƒ–ã®ä½œæˆ
# ==========================================
tab1, tab2 = st.tabs(["ğŸ”® æœªæ¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³", "ğŸ“Š éå»ãƒ‡ãƒ¼ã‚¿åˆ†æ"])

# ==========================================
# Tab 1: æœªæ¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (æ—¢å­˜æ©Ÿèƒ½)
# ==========================================
with tab1:
    st.markdown("##### 2025å¹´ã®ç€åœ°è¦‹è¾¼ã¨ç¨é‡‘äºˆæ¸¬")
    
    # --- 1. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®š (Profile) ---
    st.sidebar.header("ğŸ‘¤ ã‚ãªãŸã®ç¨å‹™å±æ€§")
    
    # åå…¥æƒ…å ±
    with st.sidebar.expander("ğŸ’° åå…¥æƒ…å ±", expanded=True):
        monthly_salary = st.number_input("æœˆé¡çµ¦ä¸ï¼ˆé¡é¢ãƒ»ä¸‡å††ï¼‰", 15, 300, 35)
        bonus_annual = st.number_input("å¹´é–“ãƒœãƒ¼ãƒŠã‚¹ï¼ˆé¡é¢ãƒ»ä¸‡å††ï¼‰", 0, 2000, 150)
        overtime_avg = st.number_input("æœˆå¹³å‡æ®‹æ¥­ä»£ï¼ˆä¸‡å††ï¼‰", 0, 100, 8)
        total_salary_monthly = monthly_salary + overtime_avg
        annual_income_raw = (total_salary_monthly * 12) + bonus_annual

    # å®¶æ—ãƒ»æ‰¶é¤Š
    with st.sidebar.expander("ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—ãƒ»æ‰¶é¤Š", expanded=False):
        has_spouse = st.checkbox("é…å¶è€…ã‚ã‚Š", value=True)
        spouse_income = 0
        if has_spouse:
            spouse_income = st.number_input("é…å¶è€…ã®å¹´åï¼ˆä¸‡å††ï¼‰", 0, 1500, 0)
        num_dependents_general = st.number_input("æ‰¶é¤Šè¦ªæ— (ä¸€èˆ¬)", 0, 5, 0)
        num_dependents_specific = st.number_input("ç‰¹å®šæ‰¶é¤Šè¦ªæ— (19-22æ­³)", 0, 5, 0)

    # æ§é™¤ãƒ»ãƒ­ãƒ¼ãƒ³
    with st.sidebar.expander("ğŸ›¡ï¸ æ§é™¤ãƒ»ä½å®…ãƒ­ãƒ¼ãƒ³", expanded=False):
        age = st.number_input("å¹´é½¢", 20, 70, 38)
        dc_monthly = st.number_input("iDeCo/DC æ›é‡‘ï¼ˆå††/æœˆï¼‰", 0, 55000, 15000, step=1000)
        furusato_annual = st.number_input("ãµã‚‹ã•ã¨ç´ç¨ï¼ˆå††/å¹´ï¼‰", 0, 500000, 30000, step=1000)
        
        has_loan = st.checkbox("ä½å®…ãƒ­ãƒ¼ãƒ³ã‚ã‚Š", value=True)
        loan_deduction = 0
        if has_loan:
            loan_balance = st.number_input("å¹´æœ«æ®‹é«˜ï¼ˆä¸‡å††ï¼‰", 0, 10000, 6000)
            house_type = st.selectbox("ä½å®…ã‚¿ã‚¤ãƒ—", ["ZEH/çœã‚¨ãƒ", "é•·æœŸå„ªè‰¯", "ä¸€èˆ¬"])
            limit = 4500 if house_type == "ZEH/çœã‚¨ãƒ" else 5000 if house_type == "é•·æœŸå„ªè‰¯" else 3000
            loan_deduction = min(loan_balance, limit) * 10000 * 0.007

    # --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
    income_val = annual_income_raw * 10000
    if income_val <= 1625000: sal_ded = 550000
    elif income_val <= 1800000: sal_ded = income_val * 0.4 - 100000
    elif income_val <= 3600000: sal_ded = income_val * 0.3 + 80000
    elif income_val <= 6600000: sal_ded = income_val * 0.2 + 440000
    elif income_val <= 8500000: sal_ded = income_val * 0.1 + 1100000
    else: sal_ded = 1950000
    salary_income = max(0, income_val - sal_ded)

    shaho = income_val * 0.15
    
    basic_ded = 480000
    spouse_ded = 380000 if (has_spouse and spouse_income <= 103) else 0
    ideco_ded = dc_monthly * 12
    total_ded = basic_ded + spouse_ded + ideco_ded + shaho
    
    taxable = max(0, salary_income - total_ded)
    
    if taxable <= 1950000: tax_raw = taxable * 0.05
    elif taxable <= 3300000: tax_raw = taxable * 0.10 - 97500
    elif taxable <= 6950000: tax_raw = taxable * 0.20 - 427500
    else: tax_raw = taxable * 0.23 - 636000
    income_tax = max(0, tax_raw - loan_deduction) * 1.021

    res_tax_raw = (taxable * 0.10) + 5000
    res_tax = max(0, res_tax_raw - (furusato_annual - 2000) - min(97500, max(0, loan_deduction - tax_raw)))

    net_income = income_val - shaho - income_tax - res_tax

    # --- Tab1 è¡¨ç¤ºã‚¨ãƒªã‚¢ ---
    c1, c2, c3 = st.columns(3)
    c1.metric("é¡é¢å¹´å", f"{annual_income_raw/10000:,.1f} ä¸‡å††")
    c2.metric("æ‰‹å–ã‚Šäºˆæ¸¬", f"{net_income/10000:,.1f} ä¸‡å††", f"è² æ‹…ç‡ {((1 - net_income/income_val)*100):.1f}%")
    c3.metric("æ¥å¹´ã®ä½æ°‘ç¨(æœˆ)", f"{res_tax/12:,.0f} å††")

    st.subheader("ğŸ“¢ ç¨å‹™ã‚¢ãƒ©ãƒ¼ãƒˆ")
    if res_tax > 300000:
        st.warning(f"âš ï¸ **ä½æ°‘ç¨æ³¨æ„:** æ¥å¹´ã¯å¹´é–“ç´„{res_tax/10000:.1f}ä¸‡å††ã®ä½æ°‘ç¨ãŒã‹ã‹ã‚Šã¾ã™ã€‚")
    if loan_deduction > 0:
        st.success(f"ğŸŸ¢ **ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤:** å¹´é–“{loan_deduction/10000:.1f}ä¸‡å††ã®ç¯€ç¨åŠ¹æœãŒå‡ºã¦ã„ã¾ã™ã€‚")

    fig = go.Figure(go.Waterfall(
        name = "20", orientation = "v",
        measure = ["relative", "relative", "relative", "relative", "total"],
        x = ["é¡é¢", "ç¤¾ä¼šä¿é™º", "æ‰€å¾—ç¨", "ä½æ°‘ç¨", "æ‰‹å–ã‚Š"],
        y = [annual_income_raw, -shaho/10000, -income_tax/10000, -res_tax/10000, net_income/10000],
        connector = {"line":{"color":"rgb(63, 63, 63)"}},
    ))
    st.plotly_chart(fig, use_container_width=True)


# ==========================================
# Tab 2: éå»ãƒ‡ãƒ¼ã‚¿åˆ†æ (ç”»åƒãƒ‡ãƒ¼ã‚¿èª­è¾¼æ¸ˆã¿)
# ==========================================
with tab2:
    st.markdown("##### ğŸ“Š 2023å¹´ã€œ2025å¹´ã®å®Ÿç¸¾æ¨ç§»")
    st.caption("â€»å…±æœ‰ã„ãŸã ã„ãŸè¡¨ãƒ‡ãƒ¼ã‚¿ã‚ˆã‚ŠæŠ½å‡ºãƒ»ã‚°ãƒ©ãƒ•åŒ–ã—ã¦ã„ã¾ã™")

    # ç”»åƒã‹ã‚‰æŠ½å‡ºã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å®šç¾©
    history_data = [
        # 2023å¹´
        {"å¹´æœˆ": "2023-01", "é¡é¢çµ¦ä¸": 520000, "æ‰‹å–ã‚Š": 476387, "æ‰€å¾—ç¨": 7180, "ä½æ°‘ç¨": 0},
        {"å¹´æœˆ": "2023-02", "é¡é¢çµ¦ä¸": 338530, "æ‰‹å–ã‚Š": 251384, "æ‰€å¾—ç¨": 8958, "ä½æ°‘ç¨": 0},
        {"å¹´æœˆ": "2023-03", "é¡é¢çµ¦ä¸": 296930, "æ‰‹å–ã‚Š": 219285, "æ‰€å¾—ç¨": 6640, "ä½æ°‘ç¨": 27100},
        {"å¹´æœˆ": "2023-04", "é¡é¢çµ¦ä¸": 329180, "æ‰‹å–ã‚Š": 249865, "æ‰€å¾—ç¨": 7820, "ä½æ°‘ç¨": 26800},
        {"å¹´æœˆ": "2023-05", "é¡é¢çµ¦ä¸": 334870, "æ‰‹å–ã‚Š": 255301, "æ‰€å¾—ç¨": 8040, "ä½æ°‘ç¨": 26800},
        {"å¹´æœˆ": "2023-06", "é¡é¢çµ¦ä¸": 335430, "æ‰‹å–ã‚Š": 282083, "æ‰€å¾—ç¨": 8040, "ä½æ°‘ç¨": 26800},
        {"å¹´æœˆ": "2023-07", "é¡é¢çµ¦ä¸": 977410, "æ‰‹å–ã‚Š": 777352, "æ‰€å¾—ç¨": 43177, "ä½æ°‘ç¨": 30200}, # è³ä¸è¾¼
        {"å¹´æœˆ": "2023-08", "é¡é¢çµ¦ä¸": 363750, "æ‰‹å–ã‚Š": 278858, "æ‰€å¾—ç¨": 9890, "ä½æ°‘ç¨": 30100},
        {"å¹´æœˆ": "2023-09", "é¡é¢çµ¦ä¸": 354010, "æ‰‹å–ã‚Š": 269906, "æ‰€å¾—ç¨": 9160, "ä½æ°‘ç¨": 30100},
        {"å¹´æœˆ": "2023-10", "é¡é¢çµ¦ä¸": 347770, "æ‰‹å–ã‚Š": 256713, "æ‰€å¾—ç¨": 8140, "ä½æ°‘ç¨": 30100},
        {"å¹´æœˆ": "2023-11", "é¡é¢çµ¦ä¸": 376690, "æ‰‹å–ã‚Š": 283220, "æ‰€å¾—ç¨": 10380, "ä½æ°‘ç¨": 30100},
        {"å¹´æœˆ": "2023-12", "é¡é¢çµ¦ä¸": 953140, "æ‰‹å–ã‚Š": 737153, "æ‰€å¾—ç¨": 50767, "ä½æ°‘ç¨": 30100}, # è³ä¸è¾¼
        # 2024å¹´
        {"å¹´æœˆ": "2024-01", "é¡é¢çµ¦ä¸": 363830, "æ‰‹å–ã‚Š": 271657, "æ‰€å¾—ç¨": 9160, "ä½æ°‘ç¨": 30100},
        {"å¹´æœˆ": "2024-02", "é¡é¢çµ¦ä¸": 371480, "æ‰‹å–ã‚Š": 278531, "æ‰€å¾—ç¨": 9890, "ä½æ°‘ç¨": 30100},
        {"å¹´æœˆ": "2024-03", "é¡é¢çµ¦ä¸": 347760, "æ‰‹å–ã‚Š": 256703, "æ‰€å¾—ç¨": 8140, "ä½æ°‘ç¨": 30100},
        {"å¹´æœˆ": "2024-04", "é¡é¢çµ¦ä¸": 381030, "æ‰‹å–ã‚Š": 285064, "æ‰€å¾—ç¨": 10380, "ä½æ°‘ç¨": 30100},
        {"å¹´æœˆ": "2024-05", "é¡é¢çµ¦ä¸": 382770, "æ‰‹å–ã‚Š": 286543, "æ‰€å¾—ç¨": 10630, "ä½æ°‘ç¨": 30100},
        {"å¹´æœˆ": "2024-06", "é¡é¢çµ¦ä¸": 370610, "æ‰‹å–ã‚Š": 314612, "æ‰€å¾—ç¨": 8420, "ä½æ°‘ç¨": 0}, # ä½æ°‘ç¨ç‰¹åˆ¥å¾´åãªã—æœˆ
        {"å¹´æœˆ": "2024-07", "é¡é¢çµ¦ä¸": 1059680, "æ‰‹å–ã‚Š": 838260, "æ‰€å¾—ç¨": 37082, "ä½æ°‘ç¨": 26500}, # è³ä¸è¾¼
        {"å¹´æœˆ": "2024-08", "é¡é¢çµ¦ä¸": 382890, "æ‰‹å–ã‚Š": 291063, "æ‰€å¾—ç¨": 10630, "ä½æ°‘ç¨": 25700},
        {"å¹´æœˆ": "2024-09", "é¡é¢çµ¦ä¸": 346030, "æ‰‹å–ã‚Š": 257014, "æ‰€å¾—ç¨": 8040, "ä½æ°‘ç¨": 25700},
        {"å¹´æœˆ": "2024-10", "é¡é¢çµ¦ä¸": 374360, "æ‰‹å–ã‚Š": 283324, "æ‰€å¾—ç¨": 10870, "ä½æ°‘ç¨": 25700},
        {"å¹´æœˆ": "2024-11", "é¡é¢çµ¦ä¸": 387090, "æ‰‹å–ã‚Š": 294997, "æ‰€å¾—ç¨": 9160, "ä½æ°‘ç¨": 25700},
        {"å¹´æœˆ": "2024-12", "é¡é¢çµ¦ä¸": 1071949, "æ‰‹å–ã‚Š": 851252, "æ‰€å¾—ç¨": 52907, "ä½æ°‘ç¨": 25700}, # è³ä¸è¾¼
        # 2025å¹´
        {"å¹´æœˆ": "2025-01", "é¡é¢çµ¦ä¸": 359740, "æ‰‹å–ã‚Š": 270012, "æ‰€å¾—ç¨": 8670, "ä½æ°‘ç¨": 25700},
        {"å¹´æœˆ": "2025-02", "é¡é¢çµ¦ä¸": 371090, "æ‰‹å–ã‚Š": 280313, "æ‰€å¾—ç¨": 9650, "ä½æ°‘ç¨": 25700},
        {"å¹´æœˆ": "2025-03", "é¡é¢çµ¦ä¸": 375200, "æ‰‹å–ã‚Š": 283501, "æ‰€å¾—ç¨": 9890, "ä½æ°‘ç¨": 25700},
        {"å¹´æœˆ": "2025-04", "é¡é¢çµ¦ä¸": 376140, "æ‰‹å–ã‚Š": 285031, "æ‰€å¾—ç¨": 10140, "ä½æ°‘ç¨": 25700},
        {"å¹´æœˆ": "2025-05", "é¡é¢çµ¦ä¸": 348260, "æ‰‹å–ã‚Š": 259305, "æ‰€å¾—ç¨": 8140, "ä½æ°‘ç¨": 25700},
        {"å¹´æœˆ": "2025-06", "é¡é¢çµ¦ä¸": 365320, "æ‰‹å–ã‚Š": 285351, "æ‰€å¾—ç¨": 9160, "ä½æ°‘ç¨": 15600},
        {"å¹´æœˆ": "2025-07", "é¡é¢çµ¦ä¸": 1366950, "æ‰‹å–ã‚Š": 1091939, "æ‰€å¾—ç¨": 87753, "ä½æ°‘ç¨": 15400}, # è³ä¸è¾¼
        {"å¹´æœˆ": "2025-08", "é¡é¢çµ¦ä¸": 499710, "æ‰‹å–ã‚Š": 407782, "æ‰€å¾—ç¨": 20580, "ä½æ°‘ç¨": 15400},
        {"å¹´æœˆ": "2025-09", "é¡é¢çµ¦ä¸": 499710, "æ‰‹å–ã‚Š": 516769, "æ‰€å¾—ç¨": 20580, "ä½æ°‘ç¨": 15400}, # èª¿æ•´ã‚ã‚Š
        {"å¹´æœˆ": "2025-10", "é¡é¢çµ¦ä¸": 319410, "æ‰‹å–ã‚Š": 292363, "æ‰€å¾—ç¨": 9890, "ä½æ°‘ç¨": 15400},
        {"å¹´æœˆ": "2025-11", "é¡é¢çµ¦ä¸": 499710, "æ‰‹å–ã‚Š": 388892, "æ‰€å¾—ç¨": 18470, "ä½æ°‘ç¨": 15400},
        {"å¹´æœˆ": "2025-12", "é¡é¢çµ¦ä¸": 1566890, "æ‰‹å–ã‚Š": 1256668, "æ‰€å¾—ç¨": 109477, "ä½æ°‘ç¨": 15400}, # è³ä¸è¾¼
    ]

    df = pd.DataFrame(history_data)

    # 1. åå…¥ã¨æ‰‹å–ã‚Šã®ãƒ©ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆ
    st.subheader("ğŸ“ˆ åå…¥ã¨æ‰‹å–ã‚Šã®æ¨ç§» (2023-2025)")
    st.line_chart(df.set_index('å¹´æœˆ')[['é¡é¢çµ¦ä¸', 'æ‰‹å–ã‚Š']])

    # 2. å¹´åé›†è¨ˆ
    st.subheader("ğŸ’° å¹´ã”ã¨ã®åˆè¨ˆ")
    df['Year'] = df['å¹´æœˆ'].apply(lambda x: x.split('-')[0])
    annual_summary = df.groupby('Year')[['é¡é¢çµ¦ä¸', 'æ‰‹å–ã‚Š', 'æ‰€å¾—ç¨', 'ä½æ°‘ç¨']].sum()
    st.dataframe(annual_summary.style.format("{:,.0f}"))

    # 3. ç¨é‡‘ã®å†…è¨³ãƒãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
    st.subheader("ğŸ’¸ ç¨è² æ‹…ã®æ¨ç§»")
    st.bar_chart(df.set_index('å¹´æœˆ')[['æ‰€å¾—ç¨', 'ä½æ°‘ç¨']], stack=True)
